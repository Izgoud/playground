<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Double pendulum</title>
   <style>
      *,
      *:before,
      *:after {
         box-sizing: border-box;
      }

      html,
      body,
      canvas {
         width: 100%;
         height: 100%;
      }

      html {
         font-size: 15px;
         font-family: 'Gill Sans', 'Gill Sans MT', sans-serif;
      }

      body {
         margin: 0;
         padding: 0;
         overflow: hidden;
      }

      #canvas {
         z-index: 10;
      }

      #canvas-line {
         background-color: #1A2530;
         color: #4c83b9;
      }

      canvas {
         position: absolute;
         top: 0;
         left: 0;
      }

      
      #double-pendulum .dg.ac {
         z-index: 100;
      }

      #double-pendulum .dg.a {
         margin-right: 0;
      }
      #double-pendulum .dg .property-name {
         width: 33%;
      }

      #double-pendulum .dg .c {
         width: 66%;
      }
   </style>
</head>
<body id="double-pendulum">
<canvas id="canvas" width="400" height="400"></canvas>
<canvas id="canvas-line" width="400" height="400"></canvas>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.7.7/dat.gui.min.js"></script>
<script>
   // Variables
   const canvas = document.getElementById('canvas');
   const canvasLine = document.getElementById('canvas-line');
   const ctx = canvas.getContext('2d');
   const ctxLine = canvasLine.getContext('2d');
   const gui = new dat.GUI({
      closeOnTop: true,
      closed: true,
      width: 320,
   });
   
   const config = {
      gravity: 0.1,
      friction: 0.2,
   }

   var lineColor = hexToRGB('#E27A3F', 0.3);
   var strokeColor = '#34495E';
   var bobColor = '#4c83b9';
   var line = {
      x: 0,
      y: 0
   }
   var availableSize = Math.min(innerWidth, innerHeight) * 0.9;

   var b1 = {
      mass: 20,
      x: 0,
      y: 0,
      angle: 0,
      dist: availableSize / 4,
      vel: 0,
      acc: 0
   }

   var b2 = {
      mass: 20,
      x: 0,
      y: 0,
      angle: Math.PI * 0.25,
      dist: availableSize / 4,
      vel: 0,
      acc: 0
   }

   let general = gui.addFolder('Config');
   general.open();
   general.add(config, 'gravity', -0.2, 0.2, 0.002);
   general.add(config, 'friction', 0, 20, 0.1);
   let b1Folder = gui.addFolder('Bob 1');
   b1Folder.open();
   b1Folder.add(b1, 'mass', 1, 200, 1);
   b1Folder.add(b1, 'dist', 20, availableSize / 4);
   let b2Folder = gui.addFolder('Bob 2');
   b2Folder.open();
   b2Folder.add(b2, 'mass', 1, 200, 1);
   b2Folder.add(b2, 'dist', 20, availableSize / 4);

   // Functions
   function calculateBobs() {
      let num1 = config.gravity * (2 * b1.mass + b2.mass) * Math.sin(b1.angle);
      let num2 = -b2.mass * -config.gravity * Math.sin(b1.angle - 2 * b2.angle);
      let num3 = -2 * Math.sin(b1.angle - b2.angle) * b2.mass;
      let num4 = b2.vel * b2.vel * b2.dist + b1.vel * b1.vel * b1.dist * Math.cos(b1.angle - b2.angle);
      let den = b1.dist * (2 * b1.mass + b2.mass - b2.mass * Math.cos(2 * b1.angle - 2 * b2.angle));
      b1.acc = (num1 + num2 + num3 * num4) / den;

      num1 = 2 * Math.sin(b1.angle - b2.angle);
      num2 = b1.vel * b1.vel * b1.dist * (b1.mass + b2.mass);
      num3 = -config.gravity * (b1.mass + b2.mass) * Math.cos(b1.angle);
      num4 = b2.vel * b2.vel * b2.dist * b2.mass * Math.cos(b1.angle - b2.angle);
      den = b2.dist * (2 * b1.mass + b2.mass - b2.mass * Math.cos(2 * b1.angle - 2 * b2.angle));
      b2.acc = (num1 * (num2 + num3 + num4)) / den;

      b1.x = b1.dist * Math.sin(b1.angle);
      b1.y = -b1.dist * Math.cos(b1.angle);
      b2.x = b1.x + b2.dist * Math.sin(b2.angle);
      b2.y = b1.y - b2.dist * Math.cos(b2.angle);

      b1.angle += b1.vel;
      b2.angle += b2.vel;
      b1.vel += b1.acc;
      b2.vel += b2.acc;

      b1.vel /= (config.friction / 1000) + 1;
      b2.vel /= (config.friction / 1000) + 1;
   }

   function drawPendulum(x, y) {
      ctx.beginPath();
      ctx.moveTo(x, y);
      ctx.lineTo(b1.x + x, b1.y + y);
      ctx.lineTo(b2.x + x, b2.y + y);
      ctx.lineWidth = 3;
      ctx.strokeStyle = strokeColor;
      ctx.stroke();

      ctxLine.beginPath();
      ctxLine.moveTo(line.x, line.y);
      ctxLine.lineTo(b2.x + x, b2.y + y);
      ctxLine.lineWidth = 1;
      ctxLine.strokeStyle = lineColor;
      ctxLine.stroke();

      ctx.beginPath();
      ctx.arc(b1.x + x, b1.y + y, 6, 0, 2*Math.PI);
      ctx.fillStyle = bobColor;
      ctx.fill();

      ctx.beginPath();
      ctx.arc(b2.x + x, b2.y + y, 6, 0, 2*Math.PI);
      ctx.fill();

      line = {
         x: b2.x + x,
         y: b2.y + y
      }
   }

   function animate() {
      requestAnimationFrame(animate);

      // Clears the canvas
      ctx.clearRect(0,0, innerWidth, innerHeight);

      // Draw Center
      ctx.beginPath();
      ctx.arc(innerWidth / 2, innerHeight / 2, 3, 0, 2*Math.PI);
      ctx.fillStyle = strokeColor;
      ctx.fill();
      ctx.closePath();

      calculateBobs();
      drawPendulum(innerWidth / 2, innerHeight / 2);
   }

   function resizeWindow() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;

      canvasLine.width = window.innerWidth;
      canvasLine.height = window.innerHeight;
   }


   // Initializations
   animate();
   resizeWindow();

   // Event Listeners
   window.addEventListener('resize', function(){
      resizeWindow();
   });

   // Utilities
   function hexToRGB(hex, alpha) {
      const r = parseInt(hex.slice(1, 3), 16),
            g = parseInt(hex.slice(3, 5), 16),
            b = parseInt(hex.slice(5, 7), 16);

      if (alpha) {
         return "rgba(" + r + ", " + g + ", " + b + ", " + alpha + ")";
      } else {
         return "rgb(" + r + ", " + g + ", " + b + ")";
      }
   }
</script>
</body>
</html>